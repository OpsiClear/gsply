name: Documentation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  check-docs:
    name: Check documentation
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Check README exists
      run: |
        test -f README.md || (echo "README.md not found" && exit 1)

    - name: Check LICENSE exists
      run: |
        test -f LICENSE || (echo "LICENSE not found" && exit 1)

    - name: Check CHANGELOG exists
      run: |
        test -f docs/CHANGELOG.md || (echo "docs/CHANGELOG.md not found" && exit 1)

    - name: Check OPTIMIZATION_SUMMARY exists
      run: |
        test -f docs/OPTIMIZATION_SUMMARY.md || (echo "docs/OPTIMIZATION_SUMMARY.md not found" && exit 1)

    - name: Validate README formatting
      run: |
        python -m pip install --upgrade pip
        pip install markdown
        python -c "
        import markdown
        with open('README.md') as f:
            md = markdown.Markdown()
            html = md.convert(f.read())
            print('README.md is valid markdown')
        "

    - name: Check for documentation completeness
      run: |
        echo "Checking for required sections in README.md..."
        grep -q "Installation" README.md || (echo "Missing Installation section" && exit 1)
        grep -q "Quick Start\|Usage" README.md || (echo "Missing Usage section" && exit 1)
        grep -q "Performance" README.md || (echo "Missing Performance section" && exit 1)
        grep -q "API Reference" README.md || (echo "Missing API Reference section" && exit 1)
        echo "All required sections found"

    - name: Check docstrings
      run: |
        pip install -e .
        python -c "
        import gsply
        assert gsply.plyread.__doc__, 'plyread missing docstring'
        assert gsply.plywrite.__doc__, 'plywrite missing docstring'
        assert gsply.detect_format.__doc__, 'detect_format missing docstring'
        print('All public APIs have docstrings')
        "

    - name: Verify performance claims in README
      run: |
        echo "Checking that README contains real-world benchmark data..."
        grep -q "400K Gaussians" README.md || (echo "Missing 400K Gaussians benchmark" && exit 1)
        grep -q "49M Gaussians/sec\|27M Gaussians/sec\|6.3M Gaussians/sec" README.md || (echo "Missing throughput metrics" && exit 1)
        echo "README contains comprehensive performance data"
